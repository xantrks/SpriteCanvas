<div class="flex flex-col xl:flex-row gap-8 h-full">
  <!-- Controls Panel -->
  <div class="xl:w-1/3 bg-white border-4 border-black p-6 neo-shadow flex flex-col gap-6">
    <!-- Mode Switcher -->
    <div class="p-1 bg-gray-200 border-2 border-black flex">
      <button
        (click)="canvasMode.set('upload')"
        [class]="canvasMode() === 'upload' ? 'bg-yellow-300' : 'bg-transparent hover:bg-yellow-100'"
        class="w-full py-2 font-bold text-black border-2 border-black"
      >
        Image-to-Tilemap
      </button>
      <button
        (click)="canvasMode.set('blank')"
        [class]="canvasMode() === 'blank' ? 'bg-yellow-300' : 'bg-transparent hover:bg-yellow-100'"
        class="w-full py-2 font-bold text-black border-2 border-black -ml-0.5"
      >
        Canvas Editor
      </button>
    </div>

    <!-- Content based on mode -->
    @if (canvasMode() === 'upload') {
      <div class="border-4 border-dashed border-black p-6 flex flex-col items-center justify-center text-center h-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <h3 class="text-xl font-bold">Upload an Image</h3>
        <p class="text-sm text-gray-600 mb-4">It will be split into a 3x3 grid.</p>
        <input type="file" (change)="handleFileUpload($event)" accept="image/*" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:border-2 file:border-black file:font-semibold file:bg-yellow-300 file:text-black hover:file:bg-yellow-400" />
      </div>
    } @else {
      <div class="flex flex-col gap-4">
        <div>
          <h3 class="text-xl font-extrabold mb-2">AI Tile Editor</h3>
          <p class="text-sm text-gray-600 mb-3">Select a tile, then describe what you want to generate.</p>
          <div class="flex gap-2">
            <input
              type="text"
              [value]="editPrompt()"
              (input)="editPrompt.set($any($event.target).value)"
              placeholder="e.g., A mossy stone tile"
              class="w-full bg-white border-2 border-black p-3 focus:outline-none focus:ring-2 focus:ring-yellow-400 font-medium"
              [disabled]="selectedTileCoords() === null"
            />
            <button
              (click)="applyAiEdit()"
              [disabled]="isLoading() || selectedTileCoords() === null"
              class="bg-cyan-400 text-black font-bold py-2 px-5 border-4 border-black neo-shadow-small btn-neo"
            >
              @if (isLoading() && selectedTileCoords() !== null) {
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                </svg>
              } @else {
                <span>GO</span>
              }
            </button>
          </div>
        </div>
        <div>
          <h3 class="text-xl font-extrabold mb-2">Canvas Size</h3>
          <div class="grid grid-cols-2 gap-2">
            <button (click)="addRow()" class="font-semibold border-2 border-black py-2 bg-white hover:bg-gray-100">+ Add Row</button>
            <button (click)="removeRow()" [disabled]="rows() <= 1" class="font-semibold border-2 border-black py-2 bg-white hover:bg-gray-100 disabled:bg-gray-200 disabled:text-gray-500">- Remove Row</button>
            <button (click)="addCol()" class="font-semibold border-2 border-black py-2 bg-white hover:bg-gray-100">+ Add Column</button>
            <button (click)="removeCol()" [disabled]="cols() <= 1" class="font-semibold border-2 border-black py-2 bg-white hover:bg-gray-100 disabled:bg-gray-200 disabled:text-gray-500">- Remove Column</button>
          </div>
        </div>
        <div>
            <h3 class="text-xl font-extrabold mb-2">Canvas View</h3>
            <div class="grid grid-cols-2 gap-2">
                <button (click)="zoomIn()" [disabled]="zoomLevel() >= maxZoom" class="font-semibold border-2 border-black py-2 bg-white hover:bg-gray-100 disabled:bg-gray-200 disabled:text-gray-500">Zoom In (+)</button>
                <button (click)="zoomOut()" [disabled]="zoomLevel() <= minZoom" class="font-semibold border-2 border-black py-2 bg-white hover:bg-gray-100 disabled:bg-gray-200 disabled:text-gray-500">Zoom Out (-)</button>
            </div>
             <button (click)="resetZoom()" class="font-semibold border-2 border-black py-2 bg-white hover:bg-gray-100 w-full mt-2">Reset Zoom ({{ zoomPercentage() }}%)</button>
        </div>
      </div>
    }

    <!-- Canvas Actions -->
    <div class="flex gap-2 justify-between mt-auto pt-4">
      <button (click)="clearCanvas()" class="bg-gray-600 text-white font-bold py-2 px-4 border-4 border-black neo-shadow-small btn-neo">
        Clear
      </button>
      <button (click)="downloadMap()" class="bg-yellow-300 text-black font-bold py-2 px-4 border-4 border-black neo-shadow-small btn-neo">
        Download Map
      </button>
    </div>
    
    @if (error()) {
      <div class="bg-red-100 border-2 border-red-500 text-red-700 px-4 py-3" role="alert">
        <p class="font-bold">Error</p>
        <p class="text-sm">{{ error() }}</p>
      </div>
    }
  </div>

  <!-- Display Panel -->
  <div class="flex-1 bg-white border-4 border-black p-6 neo-shadow flex flex-col overflow-hidden min-h-0">
     <div class="flex-grow overflow-auto bg-gray-300 p-2 border-2 border-black">
      <div 
        class="inline-grid origin-top-left transition-transform duration-150" 
        [style.grid-template-columns]="'repeat(' + cols() + ', 64px)'"
        [style.transform]="'scale(' + zoomLevel() + ')'"
      >
        @for (row of tiles(); track $index; let r = $index) {
          @for (tile of row; track $index; let c = $index) {
            <div 
              (click)="selectTile(r, c)"
              [class]="selectedTileCoords()?.row === r && selectedTileCoords()?.col === c ? 'outline outline-4 outline-offset-2 outline-yellow-400' : ''"
              class="w-16 h-16 bg-checkerboard cursor-pointer hover:outline hover:outline-cyan-500 transition-all duration-200 ease-in-out">
              @if (tile) {
                <img [src]="tile" class="w-full h-full object-contain" alt="Tile"/>
              }
            </div>
          }
        }
      </div>
    </div>
  </div>
</div>
<canvas #hiddenCanvas class="hidden"></canvas>